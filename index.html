<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asistencia Emaús Hombres</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; margin:0; padding:20px; }
    .container { max-width: 640px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.08); }
    h1 { margin:0 0 16px; text-align:center; }
    label { font-weight:600; display:block; margin-top:8px; }
    input[type="text"], input[type="date"] { width:100%; padding:10px; border:1px solid #cbd5e0; border-radius:8px; margin-top:6px; box-sizing:border-box; }
    .actions { display:grid; gap:10px; grid-template-columns: 1fr 1fr; margin-top:14px; }
    button { padding:12px; border:0; border-radius:8px; cursor:pointer; font-weight:700; }
    .primary { background:#2b6cb0; color:#fff; }
    .primary:hover { background:#234e80; }
    .secondary { background:#4a5568; color:#fff; }
    .secondary:hover { background:#2d3748; }
    .ghost { background:#edf2f7; color:#1a202c; }
    .ghost:hover { background:#e2e8f0; }
    #report { margin-top:18px; overflow:auto; background:#fff; border:1px solid #e2e8f0; border-radius:10px; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #edf2f7; text-align:left; font-size:.95rem; }
    th { background:#f7fafc; }
    #downloadBtn { display:none; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Asistencia Emaús Hombres</h1>

    <label for="docId">Escanear o ingresar ID</label>
    <input id="docId" type="text" placeholder="Escanea o escribe la identificación" autocomplete="off" />

    <div class="actions">
      <button id="btnRegister" class="primary">Registrar asistencia</button>
      <button id="btnPaste" class="ghost">Pegar ID</button>
    </div>

    <hr style="margin:20px 0;">

    <label>Informe entre fechas</label>
    <div class="actions">
      <input id="fromDate" type="date" />
      <input id="toDate" type="date" />
    </div>
    <div class="actions">
      <button id="btnReport" class="secondary">Generar informe</button>
      <button id="downloadBtn" class="ghost">Descargar CSV</button>
    </div>

    <div id="report"></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyUQvqGHZ9dJz0iPav3p4YHpOV5MQIsIcY8qk5W0h149EZUhfFsYmkpkyixXQZ1pY6ECQ/exec";

    const $ = id => document.getElementById(id);

    async function postJSON(payload){
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      try { return JSON.parse(text); } catch { return text; }
    }

    async function registrarAsistencia(){
      const id = $('docId').value.trim();
      if (!id) { alert('Ingresa o escanea la identificación'); return; }
      try {
        const data = await postJSON({ accion:'registrar', id });
        alert(data.mensaje || 'Asistencia registrada');
        $('docId').value = '';
      } catch (e) {
        console.error(e);
        alert('Error al registrar');
      }
    }

    let ultimoInforme = [];
    function renderTable(rows){
      if (!rows || !rows.length) { $('report').innerHTML = '<p>No hay registros.</p>'; $('downloadBtn').style.display='none'; return; }
      let html = '<table><thead><tr><th>Nombre</th><th>ID</th><th>Retiro</th><th>Fecha</th></tr></thead><tbody>';
      rows.forEach(r => {
        const fecha = new Date(r[3]);
        html += `<tr><td>${r[0]||''}</td><td>${r[1]||''}</td><td>${r[2]||''}</td><td>${fecha.toLocaleString()}</td></tr>`;
      });
      html += '</tbody></table>';
      $('report').innerHTML = html;
      $('downloadBtn').style.display = 'inline-block';
    }
    function descargarCSV(rows){
      const header = ['Nombre completo','Identificación','Retiro','Fecha'];
      const csv = [header.join(','), ...rows.map(r => [
        `"${(r[0]||'').toString().replace(/"/g,'""')}"`,
        `"${(r[1]||'').toString().replace(/"/g,'""')}"`,
        `"${(r[2]||'').toString().replace(/"/g,'""')}"`,
        `"${new Date(r[3]).toISOString()}"`
      ].join(','))].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'informe_asistencia.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    async function generarInforme(){
      const desde = $('fromDate').value;
      const hasta = $('toDate').value;
      if (!desde || !hasta) { alert('Selecciona ambas fechas'); return; }
      try {
        const data = await postJSON({ accion:'informe', desde, hasta });
        ultimoInforme = Array.isArray(data) ? data : [];
        renderTable(ultimoInforme);
      } catch (e) {
        console.error(e);
        alert('Error al generar informe');
      }
    }

    async function pasteFromClipboard(){
      try { const t = await navigator.clipboard.readText(); if (t) $('docId').value = t.trim(); }
      catch { alert('No se pudo leer el portapapeles'); }
    }

    $('btnRegister').addEventListener('click', registrarAsistencia);
    $('btnReport').addEventListener('click', generarInforme);
    $('downloadBtn').addEventListener('click', () => descargarCSV(ultimoInforme));
    $('btnPaste').addEventListener('click', pasteFromClipboard);
  </script>
</body>
</html>
